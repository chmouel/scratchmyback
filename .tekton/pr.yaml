---
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  name: scratchmyback-params-test
  annotations:
    # pipelinesascode.tekton.dev/on-event: "[pull_request, push]"
    # pipelinesascode.tekton.dev/on-target-branch: "[main]"
    pipelinesascode.tekton.dev/max-keep-runs: "2"
    pipelinesascode.tekton.dev/task: ".tekton/remotetask.yaml"
    pipelinesascode.tekton.dev/on-cel-expression: |
      body.pull_request.base.ref == "main" && 
        body.pull_request.user.login == "chmouel" && 
        body.action == "synchronize" && 
        headers['X-Github-Hook-Installation-Target-Type'] == 'integration'
spec:
  params:
    - name: repo_url
      value: "{{ repo_url }}"
    - name: revision
      value: "{{ revision }}"
  pipelineSpec:
    tasks:
      - name: noop-task
        taskSpec:
          steps:
            - name: python
              image: registry.access.redhat.com/ubi9/ubi
              script: |
                #!/usr/bin/env python3
                import json
                labels=json.loads("""{{ body.pull_request.labels }}""")
                for label in labels:
                    if label['name'] == 'bug':
                      print('This is a PR targetting a BUG')
                print('Can you check if the PR {{ body.pull_request.state == "open" && "is Open" }}')

            - name: bash
              image: registry.access.redhat.com/ubi9/ubi
              script: |
                if {{ body.pull_request.state == "open" }}; then
                  echo "PR is Open"
                fi
